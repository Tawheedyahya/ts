{% extends "base.html" %}
{% block title %}Client Onboarding{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width: 700px;">
  <!-- Trigger -->
  <div class="d-flex justify-content-end mb-3">
    <button type="button"
            class="btn"
            style="background-color: #142f44; color: #fff; font-weight: 600;"
            data-bs-toggle="modal"
            data-bs-target="#planDetailsModal">
      Get Details
    </button>
  </div>

  <h2 class="mb-4">New Client Onboarding</h2>
  <form method="POST" action="" id="onboardingForm">
    {% csrf_token %}

    <div class="mb-3">
      <label for="client_name" class="form-label fw-bold">Client Name</label>
      <input type="text" class="form-control" id="client_name" name="client_name" required>
    </div>

    <div class="mb-3">
      <label for="client_phone" class="form-label fw-bold">Client Phone Number</label>
      <input type="text" class="form-control" id="client_phone" name="client_phone" placeholder="Enter client's phone number" required />
    </div>

    <div class="mb-3">
      <label for="client_business" class="form-label fw-bold">Client Business</label>
      <input type="text" class="form-control" id="client_business" name="client_business" placeholder="Enter client's business" />
    </div>
    

    <div class="mb-3">
      <label for="description" class="form-label fw-bold">Description</label>
      <textarea class="form-control" id="description" name="description" rows="4" placeholder="Enter description here"></textarea>
    </div>

    <div class="mb-3">
      <label for="plans" class="form-label fw-bold">Plan</label>
      <select class="form-select" id="plans" name="plans" required>
        <option value="pro">Pro Plan</option>
        <option value="business">Business Plan</option>
        <option value="basic">Basic Plan</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="assigned_to" class="form-label fw-bold">Assign Onboarding To</label>
      <select class="form-select" id="assigned_to" name="assigned_to" required>
        <option value="" selected>Select user</option>
        <option value="suva">Suva</option>
        <option value="nithi">Nithi</option>
        <option value="hari">Hari</option>
        <option value="abinav">Abinav</option>
        <option value="aravind">Aravind</option>
        <option value="tawheed">Tawheed</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="assigned_phone" class="form-label fw-bold">Assigned User Phone</label>
      <input type="text" class="form-control" id="assigned_phone" name="assigned_phone" placeholder="Enter assigned user's phone number" />
    </div>

    <div class="mb-3">
      <label for="onboarding_deadline_days" class="form-label fw-bold">Onboarding Deadline (Days)</label>
      <input type="number" class="form-control" id="onboarding_deadline_days" name="onboarding_deadline_days" value="7" min="1" />
    </div>

    <!-- Hidden fields to receive modal values -->
    <input type="hidden" name="billing_cycle" id="billing_cycle" />
    <input type="hidden" name="plan_amount" id="plan_amount" />
    <input type="hidden" name="first_payment_date_hidden" id="first_payment_date_hidden" />
    <input type="hidden" name="number_of_months" id="number_of_months" />
    <input type="hidden" name="number_of_years" id="number_of_years" />
    <input type="hidden" name="cycle_start_date" id="cycle_start_date" />
    <input type="hidden" name="due_date" id="main_due_date" />

    <button type="submit" class="w-100" style="background-color: #142f44; color: #fff; border: none; font-weight: 600; padding: 10px 0; border-radius: 6px;">
      Add Client
    </button>
  </form>
</div>

<!-- Modal -->
<div class="modal fade" id="planDetailsModal" tabindex="-1" aria-labelledby="planDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="border-radius: 10px;">
      <div class="modal-header" style="border-bottom: 1px solid #e9ecef;">
        <h5 class="modal-title" id="planDetailsModalLabel">Plan Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- Billing Cycle -->
        <div class="mb-3">
          <label class="form-label fw-bold d-block mb-2">Billing Cycle</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="modal_billing_cycle" id="cycle_monthly" value="monthly" checked>
            <label class="form-check-label" for="cycle_monthly">Monthly</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="modal_billing_cycle" id="cycle_yearly" value="yearly">
            <label class="form-check-label" for="cycle_yearly">Yearly</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="modal_billing_cycle" id="cycle_lifetime" value="lifetime">
            <label class="form-check-label" for="cycle_lifetime">Lifetime</label>
          </div>
        </div>

        <!-- Amount -->
        <div class="mb-3">
          <label for="modal_plan_amount" class="form-label fw-bold">Amount</label>
          <input type="number" min="0" step="0.01" class="form-control" id="modal_plan_amount" placeholder="Enter amount" required>
          <div class="form-text">Enter the price</div>
        </div>

        <!-- First payment date -->
        <div class="mb-3">
          <label for="modal_first_payment_date" class="form-label fw-bold">First Payment Collected Date</label>
          <input type="date" class="form-control" id="modal_first_payment_date" name="modal_first_payment_date" required>
        </div>

        <!-- Monthly fields -->
        <div class="mb-3" id="monthly_fields">
          <label for="num_months" class="form-label fw-bold">Number of Months</label>
          <input type="number" min="1" class="form-control" id="num_months" placeholder="Enter number of months">

          <label for="monthly_start_date" class="form-label fw-bold mt-2">Start Date</label>
          <input type="date" class="form-control" id="monthly_start_date">
        </div>

        <!-- Yearly fields -->
        <div class="mb-3" id="yearly_fields" style="display:none;">
          <label for="num_years" class="form-label fw-bold">Number of Years</label>
          <input type="number" min="1" class="form-control" id="num_years" placeholder="Enter number of years">

          <label for="yearly_start_date" class="form-label fw-bold mt-2">Start Date</label>
          <input type="date" class="form-control" id="yearly_start_date">
        </div>

        <!-- Computed Due Date -->
        <div class="mb-3">
          <label for="modal_due_date" class="form-label fw-bold">Due Date</label>
          <input type="text" class="form-control" id="modal_due_date" name="modal_due_date" readonly>
        </div>

        <div class="small text-muted" id="planSummaryHint" style="display:none;"></div>
      </div>

      <div class="modal-footer" style="border-top: 1px solid #e9ecef;">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn" id="savePlanDetailsBtn" style="background-color: #142f44; color: #fff; font-weight: 600;">
          Save Details
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  // Elements (modal inputs)
  const radios        = document.querySelectorAll('input[name="modal_billing_cycle"]');
  const amountInput   = document.getElementById('modal_plan_amount');
  const firstPay      = document.getElementById('modal_first_payment_date');

  const numMonths     = document.getElementById('num_months');
  const monthlyStart  = document.getElementById('monthly_start_date');

  const numYears      = document.getElementById('num_years');
  const yearlyStart   = document.getElementById('yearly_start_date');

  const due           = document.getElementById('modal_due_date');
  const saveBtn       = document.getElementById('savePlanDetailsBtn');

  const monthlyFields = document.getElementById('monthly_fields');
  const yearlyFields  = document.getElementById('yearly_fields');

  // Hidden fields in main form
  const hCycle        = document.getElementById('billing_cycle');
  const hAmount       = document.getElementById('plan_amount');
  const hFirstPay     = document.getElementById('first_payment_date_hidden');
  const hNumMonths    = document.getElementById('number_of_months');
  const hNumYears     = document.getElementById('number_of_years');
  const hCycleStart   = document.getElementById('cycle_start_date');
  const hDue          = document.getElementById('main_due_date');

  // Utility: format YYYY-MM-DD locally (avoid timezone shifts)
  function ymd(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  // Current cycle
  function cycle() {
    return document.querySelector('input[name="modal_billing_cycle"]:checked')?.value || '';
  }

  // Toggle fields for monthly/yearly/lifetime
  function toggleFields() {
    const c = cycle();
    monthlyFields.style.display = (c === 'monthly') ? '' : 'none';
    yearlyFields.style.display  = (c === 'yearly')  ? '' : 'none';
    calcDue();
  }

  // Prefill start date(s) from first payment (convenience)
  function maybePrefillStarts() {
    if (!firstPay.value) return;
    if (!monthlyStart.value) monthlyStart.value = firstPay.value;
    if (!yearlyStart.value)  yearlyStart.value  = firstPay.value;
    calcDue();
  }

  // Calculate due date
  function calcDue() {
    const c = cycle();

    if (c === 'monthly') {
      const nm = parseInt(numMonths.value || '0', 10);
      const sd = monthlyStart.value?.trim();
      if (nm > 0 && sd) {
        const [yy, mm, dd] = sd.split('-').map(Number);
        const d = new Date(yy, mm - 1, dd);
        d.setMonth(d.getMonth() + nm);   // JS handles month overflow
        due.value = ymd(d);
      } else {
        due.value = '';
      }
    } else if (c === 'yearly') {
      const ny = parseInt(numYears.value || '0', 10);
      const sd = yearlyStart.value?.trim();
      if (ny > 0 && sd) {
        const [yy, mm, dd] = sd.split('-').map(Number);
        const d = new Date(yy, mm - 1, dd);
        d.setFullYear(d.getFullYear() + ny);
        due.value = ymd(d);
      } else {
        due.value = '';
      }
    } else {
      // lifetime or none
      due.value = '';
    }
  }

  // Save → write to hidden fields + close modal
  function saveDetails() {
    const c   = cycle();
    const amt = (amountInput.value || '').trim();

    if (!amt || Number(amt) <= 0) {
      amountInput.classList.add('is-invalid');
      amountInput.focus();
      return;
    }
    amountInput.classList.remove('is-invalid');

    hCycle.value      = c;
    hAmount.value     = amt;
    hFirstPay.value   = firstPay.value || '';
    hNumMonths.value  = (c === 'monthly') ? (numMonths.value || '') : '';
    hNumYears.value   = (c === 'yearly')  ? (numYears.value  || '') : '';
    hCycleStart.value = (c === 'monthly')
                        ? (monthlyStart.value || '')
                        : (c === 'yearly')
                          ? (yearlyStart.value || '')
                          : '';
    hDue.value        = due.value || '';

    // Optional UX: reflect selection on trigger button
    const triggerBtn = document.querySelector('[data-bs-target="#planDetailsModal"]');
    if (triggerBtn) {
      const label = c ? (c.charAt(0).toUpperCase() + c.slice(1)) : 'N/A';
      triggerBtn.textContent = `Details: ${label}${amt ? ', ' + amt : ''}`;
    }

    // Close modal
    const modalEl = document.getElementById('planDetailsModal');
    const modal   = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.hide();
  }

  // Wire events
  radios.forEach(r => r.addEventListener('change', toggleFields));
  ['input','change'].forEach(evt => {
    if (numMonths)    numMonths.addEventListener(evt, calcDue);
    if (monthlyStart) monthlyStart.addEventListener(evt, calcDue);
    if (numYears)     numYears.addEventListener(evt, calcDue);
    if (yearlyStart)  yearlyStart.addEventListener(evt, calcDue);
    if (firstPay)     firstPay.addEventListener(evt, maybePrefillStarts);
  });
  if (saveBtn) saveBtn.addEventListener('click', saveDetails);

  // Ensure modal opens even if data attributes don’t fire (safety)
  document.addEventListener('click', function(e){
    const t = e.target.closest('[data-bs-target="#planDetailsModal"]');
    if (!t) return;
    const modalEl = document.getElementById('planDetailsModal');
    if (window.bootstrap && bootstrap.Modal) {
      bootstrap.Modal.getOrCreateInstance(modalEl).show();
    }
  });

  // Init
  toggleFields();
})();
</script>
{% endblock %}
